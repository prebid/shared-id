version: 2.1

orbs:
  cloudformation: frameio/cloudformation@0.17.3
#  aws-ecr: circleci/aws-ecr@6.14.0
  maven: circleci/maven@1.0.3 # https://circleci.com/developer/orbs/orb/circleci/maven

# use the same executor for all the jobs;
executors:
  docker-executor:
    docker:
      - image: cimg/openjdk:11.0

main_only: &main_only
  filters:
    branches:
      only:
        - main
        - 'add-environments'

# Reusable Jobs
# @TODO: not used right now, but should be tested to ensure that they work and do what is expected; e.g. build, test, & publish
jobs:
  build:
    executor: docker-executor
    steps:
      - maven/test:
          command: 'build' # same as `mvn build`

  unit_test:
    executor: docker-executor
    steps:
      - maven/test # checkout, build, test, and upload test results

  # same as `mvn package`
  package:
    executor: docker-executor
    steps:
      - maven/test:
          command: 'package'
      - maven/test:
          command: 'docker:build'
      - maven/test:
          command: 'docker:push'

workflows:
  deploy:
    jobs:
#      - cloudformation/deploy:
#          name: 'Deploy to ECR'
#          stack_name: SharedID-repo
#          template: ./.cloudformation/repo.yml
#          args: --no-fail-on-empty-changeset --parameter-overrides="RepoName=SharedID"
      - cloudformation/deploy:
          name: 'Deploy to Staging'
          stack_name: SharedID-staging-1
          template: ./.cloudformation/cluster.yml
          args: --capabilities CAPABILITY_NAMED_IAM --no-fail-on-empty-changeset --parameter-overrides Certificate=arn:aws:acm:us-west-2:888340278975:certificate/f2c4fcd1-2061-41c0-a0f5-c14124cd1b3b
          <<: *main_only
#         requires:
#           - 'Deploy to ECR'
      - 'Go to Production?':
          type: approval
          requires:
            - 'Deploy to Staging'
          <<: *main_only
      - cloudformation/deploy:
          name: 'Deploy to Production Cluster'
          stack_name: SharedID-prod-1 # stack_name has to be short here, since we're using it for constructin of other names in Cloudformation, and it has a 32 character length
          template: ./.cloudformation/cluster.yml
          args: --capabilities CAPABILITY_NAMED_IAM --no-fail-on-empty-changeset --parameter-overrides Certificate=arn:aws:acm:us-west-2:888340278975:certificate/f2c4fcd1-2061-41c0-a0f5-c14124cd1b3b
          requires:
            - 'Go to Production?'
          <<: *main_only
